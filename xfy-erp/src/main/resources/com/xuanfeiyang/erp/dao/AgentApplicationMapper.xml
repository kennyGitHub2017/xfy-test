<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xuanfeiyang.erp.dao.AgentApplicationDao">
	
	<sql id="basic_column">
		user_id,name,email,mobile,address,created_time,
		seller_id,type,status
	</sql>
	<select id="load" resultType="UserInfo" parameterType="java.lang.Integer">
		select 
		<include refid="basic_column"/>
		from user_info 
		where is_delete = 0
		and user_id = #{userId}
	</select>
	
	<update id="approve" parameterType="java.lang.Integer">
		update user_info set status = 1,last_updated_time = sysdate,status_time = sysdate
		where user_id = #{userId}
	</update>
	
	<update id="unapprove" parameterType="UserInfo">
		update user_info set status = 2,note = #{param.note},last_updated_time = sysdate,status_time = sysdate
		where user_id = #{param.userId}
	</update>
	
	<update id="update" parameterType="UserInfo">
		update user_info 
		<set>
			<if test="param.locked != null">
				locked = #{param.locked},
			</if>
			<if test="param.lockedTime != null">
				locked_time = #{param.lockedTime}
			</if>
		</set>
		where user_id = #{param.userId}
	</update>
	
	<update id="delete" parameterType="java.lang.Integer">
		update user_info set is_delete = 1
		where user_id = #{userId}
	</update>
	
	<select id="findPage" resultType="UserInfo">
		select u.user_id,u.name,u.email,u.address,u.note,u.created_time,
		u.seller_id,u.type,u.status,u.locked,
		(select count(*) from sellers s where s.agent_user_id = u.user_id) as count
		from user_info u 
		<where>
			<if test="params.status != null">
				and u.status = #{params.status}
			</if>
				and u.is_delete = 0
				and u.type = 3
			<if test="params.name != null and params.name != '' ">
				and u.name like '%' || #{params.name} || '%'
			</if>
			<if test="params.mobile != null and params.mobile != '' ">
				and u.mobile like '%' || #{params.mobile} || '%'
			</if>
			<if test="params.createdTimeFrom != null and params.createdTimeFrom != '' ">
				and u.created_time >= TO_DATE(#{params.createdTimeFrom},'yyyy-mm-dd hh24:mi:ss')
			</if>
			<if test="params.createdTimeTo != null and params.createdTimeTo != '' ">
				and u.created_time <![CDATA[<]]> TO_DATE(#{params.createdTimeTo},'yyyy-mm-dd hh24:mi:ss') + 1
			</if>
		</where>
		order by u.created_time desc
	</select>
</mapper>